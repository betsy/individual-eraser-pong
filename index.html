<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Socket.io</title>
    </head>
 
    <body>
        <canvas id="myCanvas"></canvas>
        <script src="/socket.io/socket.io.js"></script>
        <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
        <script src="game.js"></script>

        <script>

var socket = io();
var boxes = game.make_boxes();
(function() {
    var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
    window.requestAnimationFrame = requestAnimationFrame;
})();

var canvas = document.getElementById("myCanvas"),
 ctx = canvas.getContext("2d"),
 width = 600,
 height = 600;

canvas.width = width;
canvas.height = height;

var width = game.consts.width,
    height = game.consts.height,
    player = game.player,
    keys = [];

socket.on('player', function (p1) {
  player = p1;
  // console.log(player.x,player.y);
})

function draw(){
  game.update(player, boxes, keys)
  ctx.clearRect(0,0,width,height);
  ctx.fill();
  ctx.fillStyle = "red";
  ctx.fillRect(player.x, player.y, player.width, player.height);

  ctx.fillStyle = "black";
  

  for (var i = 0; i < boxes.length; i++) {
    for (var j = 0; j < boxes[i].length; j++) {
        if (boxes[i][j] == 1){
          ctx.rect(j*game.consts.block_size, i*game.consts.block_size, game.consts.block_size, game.consts.block_size);
        }
    }
  }

  requestAnimationFrame(draw);
}

document.body.addEventListener("keydown", function(e) {
    socket.emit ('player move', {keyCode: e.keyCode, val: true});
});
 
document.body.addEventListener("keyup", function(e) {
    socket.emit ('player move', {keyCode: e.keyCode, val: false});
});

canvas.addEventListener("mousedown",function(e){
     var mousePos = getMousePos(canvas, e);
     socket.emit('clicked', {
        x: (mousePos.x - (mousePos.x%game.consts.block_size))/game.consts.block_size,
        y: (mousePos.y - (mousePos.y%game.consts.block_size))/game.consts.block_size
     });
});
 
window.addEventListener("load",function(){
    draw();
});

function getMousePos(canvas, evt) {
        var rect = canvas.getBoundingClientRect();
        return {
          x: evt.clientX - rect.left,
          y: evt.clientY - rect.top
        };
      }
function getRandomColor() {
    var letters = '0123456789ABCDEF';
    var color = '#';
    for (var i = 0; i < 6; i++ ) {
          color += letters[Math.floor(Math.random() * 16)];
    }
    return color;
}

            </script>
        </body>
    </body>
</html>